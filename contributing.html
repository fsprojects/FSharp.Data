<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Contributing to F# Data
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The F# Data library implements type providers for working with structured file formats (CSV, JSON and XML) and for accessing the WorldBank and Freebase data. It also includes helpers for other data-related tasks.">
    <meta name="author" content="Tomas Petricek">

    <script src="http://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="http://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="http://fsharp.github.com/FSharp.Data/content/style.css" />
    <script src="http://fsharp.github.com/FSharp.Data/content/tips.js" type="text/javascript"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/fsharp/FSharp.Data">github page</a></li>
          <li><a href="http://fsharp.github.com/fsharpx/">fsharpx library</a></li>
        </ul>
        <h3 class="muted">F# Data Library</h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          <h1>Contributing to F# Data</h1>

<p>This page should provide you with some basic information if you're thinking about
contributing to the F# Data package. It gives a brief summary of the library 
structure, how type providers are written and how the F# Data library handles 
multi-targeting (to make the providers available for Desktop, Silverlight as well
as Portable libraries).</p>

<ul>
<li><p>This page can be edited by sending a pull request to F# Data on GitHub, so
if you learn something when playing with F# Data, please record your
<a href="https://github.com/fsharp/FSharp.Data/blob/master/samples/contributing.md">findings here</a>!</p></li>
<li><p>If you want to discuss a feature (a good idea!), or if you want to look at 
suggestions how you might contribute, check out the
<a href="https://github.com/fsharp/FSharp.Data/issues">Issue list</a> on GitHub or send
an email to the <a href="http://groups.google.com/group/fsharp-opensource">F# Open-Source mailing list</a>.</p></li>
</ul>

<h2>Solution files</h2>

<p>The root directory contains a number of Visual Studio solutions (<code>*.sln</code>) files 
that group the projects in the main logical groups:</p>

<ul>
<li><p><strong>FSharp.Data.sln</strong> contains the main projects that implement most of the F# Data
functionality (such as runtime and design-time type provider libraries). If you want
to contribute code that is not quite ready yet, but looks interesting, then please
add it to the experimental projects.</p></li>
<li><p><strong>FSharp.Data.Tests.sln</strong> is a library with tests for F# Data and it also contains
the content of this web site (as <code>*.fsx</code> and <code>*.md</code>) files. Look here if you want
to edit the documentation!</p></li>
<li><p><strong>FSharp.Data.Demos.sln</strong> contains a couple of larger projects that demonstrate the
F# Data type providers in various configurations (Silverlight, Portable library
referenced from Windows Phone applications). Feel free to contribute more exciting
samples!</p></li>
</ul>

<h2>Projects and multi-targetting</h2>

<p>One problem with developing type providers is supporting multiple versions of the .NET 
platform. Type providers consist of two components:</p>

<ul>
<li><p><strong>Runtime</strong> is the part of the type provider that is actually used when the
compiled F# code that uses the provider runs. This assembly also has the
non type-provider components of FSharp.Data: the JSON and CSV parsers, and
the HTTP utilities.</p></li>
<li><p><strong>Design time</strong> is the part that is used when editing F# code that uses type
provider in your favourite editor or when compiling code. For example, in the
CSV provider, this component does the type inference and generates types
(that are mapped to runtime components by the compiler).</p></li>
</ul>

<p>To support multiple targets, we need a <em>runtime component</em> for every single target
(Silverlight, .NET 4.0 and Portable profile). However, we only need one <em>design time</em>
component, because that is always going to be executed on desktop .NET in Visual Studio
or MonoDevelop. (Well, the truth is that we actually need another <em>design time</em> version
for Silverlight to support the <a href="http://tryfsharp.org">tryfsharp.org</a> web site...)</p>

<p>So, there are 4 versions of <em>runtime</em> components and 2 versions of <em>design time</em> 
components. At the moment, this is done by having separate project file for each
component, but they share the same files - the project just defines some symbols that
are then used to include/exclude parts that are not available on certain platforms
using <code>#if</code>. There are also 2 versions of <em>runtime</em> components and 2 versions of <em>design time</em> components
for the experimental projects.</p>

<p>If you open <code>FSharp.Data.sln</code>, you'll see the following projects for <em>runtime components</em>:</p>

<ul>
<li><strong>FSharp.Data</strong> - the desktop .NET 4.0 version</li>
<li><strong>FSharp.Data.Portable</strong> - F# portable library version (targetting desktop .NET 4.0, Windows Phone 8 and Windows 8)</li>
<li><strong>FSharp.Data.Silverlight</strong> - Silverlight 5 version</li>
<li><strong>FSharp.Data.WindowsPhone7</strong> - Windows Phone 7 version</li>
<li><strong>FSharp.Data.Experimental</strong> - the desktop .NET 4.0 version of the experimental features</li>
<li><strong>FSharp.Data.Experimental.Portable</strong> - F# portable library version of the experimental features</li>
</ul>

<p>Although you could use the portable library in Silverlight, the Freebase provider doesn't work because 
of problems referencing the correct version of the System.Core assembly which has the LINQ query operators.
The XmlProvider also doesn't work in Silverlight both when using the portable version or the Silverlight specific version.
For the experimental project there's no need to have a separate Silverlight build.</p>

<p>The <em>design time</em> components are in the following projects:</p>

<ul>
<li><strong>FSharp.Data.DesignTime</strong> - the main version for desktop editors</li>
<li><strong>FSharp.Data.DesignTime.Silverlight</strong> - an experimental version for Try F#</li>
<li><strong>FSharp.Data.Experimental.DesignTime</strong> - the main version for desktop editors</li>
<li><strong>FSharp.Data.Experimental.DesignTime.Silverlight</strong> - an experimental version for Try F#</li>
</ul>

<p>Because the latest available FSharp.Core version for the Windows Phone 7 platform is from F# 2.0,
this version doesn't support type providers, so it only has the runtime components of FSharp.Data.
To build it you also need to edit <code>C:\Program Files (x86)\Microsoft SDKs\F#\3.0\Framework\v4.0\Microsoft.FSharp.targets</code>
to remove the following lines:</p>

<pre class="fssnip">
<span class="l">1: </span><span class="o">&lt;</span><span class="i">Error</span>
<span class="l">2: </span>    <span class="i">Condition</span><span class="o">=</span><span class="s">&quot;</span><span class="s">&#39;</span><span class="s">$</span><span class="s">(</span><span class="s">SilverlightVersion</span><span class="s">)</span><span class="s">&#39;</span><span class="s"> </span><span class="s">!</span><span class="s">=</span><span class="s"> </span><span class="s">&#39;</span><span class="s">&#39;</span><span class="s"> </span><span class="s">and</span><span class="s"> </span><span class="s">&#39;</span><span class="s">$</span><span class="s">(</span><span class="s">SilverlightVersion</span><span class="s">)</span><span class="s">&#39;</span><span class="s"> </span><span class="s">!</span><span class="s">=</span><span class="s"> </span><span class="s">&#39;</span><span class="s">v5</span><span class="s">.</span><span class="s">0</span><span class="s">&#39;</span><span class="s">&quot;</span>
<span class="l">3: </span>    <span class="i">Text</span><span class="o">=</span><span class="s">&quot;</span><span class="s">In</span><span class="s"> </span><span class="s">this</span><span class="s"> </span><span class="s">version</span><span class="s"> </span><span class="s">of</span><span class="s"> </span><span class="s">Visual</span><span class="s"> </span><span class="s">Studio</span><span class="s">,</span><span class="s"> </span><span class="s">F</span><span class="s">#</span><span class="s"> </span><span class="s">for</span><span class="s"> </span><span class="s">Silverlight</span><span class="s"> </span><span class="s">can</span><span class="s"> </span><span class="s">only</span><span class="s"> </span><span class="s">target</span><span class="s"> </span><span class="s">Silverlight</span><span class="s"> </span><span class="s">v5</span><span class="s">.</span><span class="s">0</span><span class="s">.</span><span class="s"> </span><span class="s">Use</span><span class="s"> </span><span class="s">a</span><span class="s"> </span><span class="s">prior</span><span class="s"> </span><span class="s">version</span><span class="s"> </span><span class="s">of</span><span class="s"> </span><span class="s">Visual</span><span class="s"> </span><span class="s">Studio</span><span class="s"> </span><span class="s">to</span><span class="s"> </span><span class="s">target</span><span class="s"> </span><span class="s">previous</span><span class="s"> </span><span class="s">versions</span><span class="s"> </span><span class="s">of</span><span class="s"> </span><span class="s">Silverlight</span><span class="s"> </span><span class="s">with</span><span class="s"> </span><span class="s">F</span><span class="s">#</span><span class="s">.</span><span class="s">&quot;</span>
<span class="l">4: </span><span class="o">/&gt;</span></pre>


<h3>Type provider structure</h3>

<p>Several of the F# Data type providers have similar structure - the CSV, JSON and XML
providers all infer the types from structure of a sample input. In addition, they all
have a runtime component (CSV parser, JSON parser or wrapper for <code>XDocument</code> type in .NET).</p>

<p>So, how is a typical type provider implemented? First of all, there are some shared 
files - in <code>Common</code> and <code>Library</code> subdirectories of the projects. These contain common
<em>runtime</em> components (such as parsers, HTTP helpers, etc.)</p>

<p>Next, there are some common <em>design-time</em> components. These can be found in <code>Providers</code>
folder (in the 2 design time projects) and contain the <code>ProvidedTypes</code> helpers from the
F# team, <code>StructureInference.fs</code> (which implements type inference for structured data)
and a couple of other helpers.</p>

<p>A type provider, such as JSON provider, is then located in a single folder with a number
of files, typically like this:</p>

<ul>
<li><p><code>JsonRuntime.fs</code> - the only <em>runtime</em> component. Contains CSV parser and other 
objects that are called by code generated by the type provider.</p></li>
<li><p><code>JsonInference.fs</code> - <em>design-time</em> component that infers the structure using 
the common API in <code>StructureInference.fs</code>.</p></li>
<li><p><code>JsonGenerator.fs</code> - implements code that generates provided types, adds properties
and methods etc. This uses the information infered by inference and it generates
calls to the runtime components.</p></li>
<li><p><code>JsonProvider.fs</code> - entry point that defines static properties of the type provider,
registers the provided types etc.</p></li>
</ul>

<p>The WorldBank, Freebase and Apiary providers are different. They do not need inference, but 
they still distinguish between <em>runtime</em> and <em>design-time</em> components, so you'll find at least
two files (and possibly some additional helpers).</p>

<h2>Source code</h2>

<h3>Assembly replacer</h3>

<p>Generating code in type providers (see e.g. <code>JsonGenerator.fs</code>) is a bit tricky, because 
the generated code needs to contain references to the appropriate runtime assembly 
(Silverlight, Desktop or Portable profile). This is particularly tricky When using F# quotations 
to produce the generated code. If the source code contains <code>&lt;@@ foo.Bar @@&gt;</code>, then the 
quoation has a direct reference to the type of <code>foo</code> from the current assembly.</p>

<p>This is handled by Assembly replacer (see <code>AssemblyReplacer.fs</code> in <code>Providers</code>) which
transforms quotations and replaces references with the right versions. For more information
about how this works, see also the <a href="https://github.com/fsharp/FSharp.Data/pull/5">discussion on GitHub</a>.</p>

<p>Here is a documentation for the <code>AssemblyReplacer</code> type:</p>

<blockquote>
  <p>When we split a type provider into a runtime assembly and a design time assembly, we can no longer 
use quotations directly, because they will reference the wrong types. <code>AssemblyReplacer</code> fixes that 
by transforming the expressions generated by the quotations to have the right types.</p>

  <p>On all expressions  that we provide to <code>InvokeCode</code> and <code>GetterCode</code> of <code>ProvidedMethod</code>, <code>ProvidedConstructor</code>,
and <code>ProvidedProperty</code>, instead of <code>(fun args -&gt; &lt;@@ doSomethingWith(%%args) @@&gt;)</code>, we should use 
<code>(fun args -&gt; let args = replacer.ToDesignTime args in replacer.ToRuntime &lt;@@ doSomethingWith(%%args) @@&gt;)</code>.</p>

  <p>When creating the <code>ProvidedXYZ</code> type, we have to always specify the runtime type, and when it invokes
the function provided to <code>InvokeCode</code> and <code>GetterCode</code>, we to first transform the argument expressions
to the design time types, so we can splice it in the quotation, and then after that we have to convert
it back to the runtime type.</p>

  <p>A further complication arises because <code>Expr.Var</code>'s have reference equality, so when can't just create 
new <code>Expr.Var</code>'s with the same variable name and a different type. When transforming them from runtime 
to design time we keep them in a dictionary, so that when we convert them back to runtime we can return 
the exact same instance that was provided to us initially.</p>

  <p>Another limitation (not only of this method, but in general with type providers) is that we can never use 
expressions that use F# functions as parameters or return values, we always have to use felegates instead.</p>
</blockquote>

<p>All standard type providers obtain an instance of <code>AssemblyReplacer</code> when constructed and then pass it
to the code generator, which can use it to generate appropriate code:</p>

<pre class="fssnip">
<span class="l"> 1: </span><span class="k">type</span> <span class="i">AssemblyReplacer</span> <span class="o">=</span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>  <span class="c">/// Gets the equivalent runtime type</span>
<span class="l"> 4: </span>  <span class="k">abstract</span> <span class="k">member</span> <span class="i">ToRuntime</span> <span class="o">:</span> <span class="i">designTimeType</span><span class="o">:</span><span class="i">Type</span> <span class="k">-&gt;</span> <span class="i">Type</span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>  <span class="c">/// Gets an equivalent expression with all the types </span>
<span class="l"> 7: </span>  <span class="c">/// replaced with runtime equivalents</span>
<span class="l"> 8: </span>  <span class="k">abstract</span> <span class="k">member</span> <span class="i">ToRuntime</span> <span class="o">:</span> <span class="i">designTimeTypeExpr</span><span class="o">:</span><span class="i">Expr</span> <span class="k">-&gt;</span> <span class="i">Expr</span>
<span class="l"> 9: </span>
<span class="l">10: </span>  <span class="c">/// Gets an equivalent expression with all the types </span>
<span class="l">11: </span>  <span class="c">/// replaced with designTime equivalents</span>
<span class="l">12: </span>  <span class="k">abstract</span> <span class="k">member</span> <span class="i">ToDesignTime</span><span class="o">:</span> <span class="i">runtimeExpr</span><span class="o">:</span><span class="i">Expr</span> <span class="k">-&gt;</span> <span class="i">Expr</span></pre>


<h2>Documentation</h2>

<p>The documentation for the F# Data library is automatically generated using the 
<a href="https://github.com/tpetricek/FSharp.Formatting">F# Formatting</a> library. It turns 
<code>*.md</code> (Markdown with embedded code snippets) and <code>*.fsx</code> files (F# script file with 
embedded Markdown documentation) to a nice HTML documentation.</p>

<ul>
<li><p>The code for all the documents can be found in the <code>samples</code> directory
<a href="https://github.com/fsharp/FSharp.Data/tree/master/samples">on GitHub</a>. If you
find a bug or add a new feature, make sure you document it!</p></li>
<li><p>Aside from direct documentation for individual types, there is also a <code>tutorials</code> folder
(<a href="https://github.com/fsharp/FSharp.Data/tree/master/samples/tutorials">on GitHub</a>) where
you can add additional samples and tutorials that show some interesting aspects of F# Data.</p></li>
<li><p>If you want to build the documentation, simply run the <code>build.fsx</code> script
(<a href="https://github.com/fsharp/FSharp.Data/blob/master/tools/build.fsx">GitHub link</a>) which
builds the documentation.</p></li>
</ul>

<h2>Related articles</h2>

<p>If you want to learn more about writing type providers in general, here are some useful resources:</p>

<ul>
<li><p><a href="http://blogs.msdn.com/b/fsharpteam/archive/2011/09/24/developing-f-type-providers-with-the-f-3-0-developer-preview-an-introductory-guide-and-samples.aspx">Writing F# Type Providers with the F# 3.0 Developer Preview - An Introductory Guide and Samples</a></p></li>
<li><p><a href="http://fsharp3sample.codeplex.com/">F# 3.0 Sample Pack</a> contains a number of examples ranging
from quite simple, to very complex.</p></li>
<li><a href="http://msdn.microsoft.com/en-gb/library/hh361034.aspx">Tutorial: Creating a Type Provider (F#)</a></li>
</ul>

          <div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">namespace System.Reflection</div>
<div class="tip" id="fs3">namespace Microsoft</div>
<div class="tip" id="fs4">namespace Microsoft.FSharp</div>
<div class="tip" id="fs5">namespace Microsoft.FSharp.Quotations</div>

        </div>
        <div class="span3">

          <ul class="nav nav-list" id="menu">
            <li class="nav-header">F# Data Library</li>
            <li><a href="http://fsharp.github.com/FSharp.Data/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="https://nuget.org/packages/FSharp.Data">Get Library via NuGet</a></li>
            <li><a href="https://github.com/fsharp/FSharp.Data">Source Code on GitHub</a></li>
            <li><a href="https://github.com/fsharp/FSharp.Data/blob/master/LICENSE.md">License (Apache 2.0)</a></li>
            <li><a href="https://github.com/fsharp/FSharp.Data/blob/master/RELEASE_NOTES.md">Release Notes</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/contributing.html">Contributing to F# Data</a></li>
            
            <li class="nav-header">Documentation</li>
            <li><a href="http://fsharp.github.com/FSharp.Data/fsharpdata.html">F# Data Library</a></li>
            <li class="divider"></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/JsonProvider.html">JSON Type Provider</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/XmlProvider.html">XML Type Provider</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/CsvProvider.html">CSV Type Provider</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/WorldBank.html">WorldBank Provider</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/Freebase.html">Freebase Provider</a></li>
            <li class="divider"></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/JsonValue.html">JSON Parser and Reader</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/CsvFile.html">CSV Parser and Reader</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/library/Http.html">HTTP Utilities</a></li>

            <li class="nav-header">Experimental</li>
            <li><a href="http://fsharp.github.com/FSharp.Data/experimental.html">F# Data Experimental</a></li>
            <li><a href="http://fsharp.github.com/FSharp.Data/experimental/ApiaryProvider.html">Apiary Type Provider</a></li>

          </ul>

        </div>
      </div>
    </div>
    <a href="https://github.com/fsharp/FSharp.Data"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
  </body>
  </html>